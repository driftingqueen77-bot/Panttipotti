<!doctype html>
<!-- PanttiPotti Deluxe v11.3 (always draw mouth, simple background, debug frames) -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>PanttiPotti Deluxe</title>
<style>
  :root{--bg:#fff7e9;--ink:#222;--panel:#e6f0e7;--green:#3e8f4a;--accent:#ff6a00}
  html,body{height:100%;margin:0;background:var(--bg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink)}
  .w{max-width:560px;margin:0 auto;padding:10px}
  h1{display:flex;align-items:center;gap:8px;justify-content:center;margin:8px 0 6px;font-size:22px}
  .top{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .c{background:#fff;border:2px solid #0002;border-radius:14px;padding:8px 12px;font-weight:700;box-shadow:0 2px 0 #0003}
  .best{border-color:#8e44ad}
  #g{width:100%;aspect-ratio:9/16;display:block;background:var(--panel);border:3px solid #234;border-radius:18px;touch-action:none}
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:8px 0}
  .btn{display:inline-block;background:var(--accent);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:800;box-shadow:0 4px 0 #0005;cursor:pointer}
  select{appearance:none;border:2px solid #0002;background:#fff;border-radius:10px;padding:10px;font-weight:700}
  .sheet{background:#fff;border:1px dashed #bbb;padding:14px 14px 12px;border-radius:12px}
  .sheet h3{margin:0 0 8px;font-size:16px}
  .sheet .row{display:flex;justify-content:space-between;margin:4px 0}
  .sheet .line{height:1px;background:repeating-linear-gradient(90deg,#ccc 0 8px,transparent 8px 12px);margin:8px 0}
  .muted{opacity:.65}
  .pop{animation:pop .15s ease-out}
  @keyframes pop{from{transform:scale(1)}50%{transform:scale(1.08)}to{transform:scale(1)}}
  .led{position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .12s}
  .led.ok{background:rgba(80,255,120,.22)}
  .led.bad{background:rgba(255,60,60,.22)}
  .badge{font-weight:800;padding:4px 8px;border-radius:8px;background:#ffe59a}
</style>

<div class="w">
  <h1>ü•§ PanttiPotti Deluxe</h1>

  <div class="top">
    <div class="c">‚è±Ô∏è <span id="t">40</span>s</div>
    <div class="c">‚Ç¨ <span id="s">0,00</span></div>
    <div class="c">Combo √ó<span id="b">1</span></div>
    <div class="c best">üèÜ <span id="best">0,00</span></div>
    <div class="c"><span id="status" class="muted">Valmis</span></div>
  </div>

  <div style="position:relative">
    <canvas id="g"></canvas>
    <div id="led" class="led"></div>
  </div>

  <div class="bar">
    <div>
      Vaikeus:
      <select id="mode">
        <option value="easy">Helppo</option>
        <option value="normal" selected>Normaali</option>
        <option value="hard">Vaikea</option>
      </select>
      <span id="badges"></span>
    </div>
    <button class="btn" id="start">Aloita / Uudestaan</button>
  </div>

  <div id="rc" class="sheet" style="display:none;margin-top:10px"></div>
</div>

<script>
(()=>{
// --- asetukset
const SHOW_DEBUG = true;     // jos haluat piilottaa kehykset: false

// --- DOM & koko
const cvs=g, ctx=cvs.getContext('2d');
const timeEl=t, scoreEl=s, comboEl=b, bestEl=best, btn=start, rcEl=rc, modeSel=mode, ledEl=led, statusEl=status, badgesEl=badges;
function fit(){const r=cvs.getBoundingClientRect();const h=r.width*16/9;cvs.width=r.width;cvs.height=h;cvs.style.height=h+'px'}
addEventListener('resize',fit); fit();

// --- tila (pelisilmukka lis√§t√§√§n my√∂hemmin; nyt keskityt√§√§n n√§kyvyyteen)
let run=false,time=40,bonus=0,booster=0;
const mouth={x:0,y:0,w:0,h:0}, funnel={x:0,y:0,w:0,h:0};

// --- apufunktioita
function rr(x,y,w,h,r){const R=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+R,y);ctx.arcTo(x+w,y,x+w,y+h,R);ctx.arcTo(x+w,y+h,x,y+h,R);ctx.arcTo(x,y+h,x,y,R);ctx.arcTo(x,y,x+w,y,R);ctx.closePath()}

// --- UUSI: piirr√§ suu/paneeli AINA (my√∂s ennen Startia)
function drawMachine(){
  const W=cvs.width, H=cvs.height, mx=16, my=H*0.20, mw=W-32, mh=H*0.22;

  // Paneelin tausta (yksinkertainen ‚Äî helpompi n√§hd√§)
  ctx.fillStyle = '#f3f7f3'; ctx.fillRect(0,0,W,H);

  // Vihre√§ paneeli
  ctx.fillStyle = '#3e8f4a';
  rr(mx,my,mw,mh,16); ctx.fill();

  // Suppilo + suu
  funnel.x=W*0.15; funnel.w=W*0.70; funnel.y=my+mh*0.10; funnel.h=mh*0.80;
  mouth.x =W*0.22; mouth.w=W*0.56; mouth.y=my+mh*0.22; mouth.h=mh*0.56;

  // Musta suu
  ctx.fillStyle='#0c2410';
  rr(mouth.x,mouth.y,mouth.w,mouth.h,26); ctx.fill();

  // Valkoinen ohut kehys suun ymp√§ri (n√§kyy varmasti)
  ctx.strokeStyle='rgba(255,255,255,.55)'; ctx.lineWidth=2;
  rr(mouth.x,mouth.y,mouth.w,mouth.h,26); ctx.stroke();

  // Hinnat
  ctx.fillStyle='#fff'; ctx.font='bold 16px system-ui,-apple-system,Segoe UI,Roboto';
  ctx.fillText('+0,15‚Ç¨ / +0,20‚Ç¨ / +0,40‚Ç¨ / ‚≠ê 2,00‚Ç¨', mx+14, my+22);

  // DEBUG-kehykset
  if (SHOW_DEBUG) {
    ctx.strokeStyle='magenta'; ctx.setLineDash([5,3]);
    ctx.strokeRect(funnel.x, funnel.y, funnel.w, funnel.h);
    ctx.setLineDash([]);
  }
}

// --- HUD (vain aika & badges t√§ss√§ vaiheessa)
function hud(){
  timeEl.textContent=Math.max(0,Math.ceil(time));
  const badges=[];
  if(booster>0) badges.push(`<span class="badge">BOOST √ó2 ${Math.ceil(booster)}s</span>`);
  if(bonus>0)   badges.push(`<span class="badge">BONUS √ó2 ${Math.ceil(bonus)}s</span>`);
  badgesEl.innerHTML=badges.join(' ');
}

// --- idle-render: PIIRRET√Ñ√ÑN HETI sivun latauksessa
function renderIdle(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  drawMachine();
  hud();
}
renderIdle();

// --- Start nappi (vain k√§ynnistet√§√§n loop ja p√§ivitet√§√§n status)
btn.addEventListener('click', () => { run=true; statusEl.textContent='K√§ynniss√§'; requestAnimationFrame(loop) });
btn.addEventListener('touchstart', e=>{ run=true; statusEl.textContent='K√§ynniss√§'; requestAnimationFrame(loop); e.preventDefault() }, {passive:false});

// --- pelisilmukka (nyt viel√§ kevyt: vain kone piirret√§√§n joka frame)
let last=0;
function loop(ts){
  if(!run) return; if(!last) last=ts; const dt=Math.min(32,ts-last)/1000; last=ts;
  time -= dt; if(time<=0){ time=0; run=false; statusEl.textContent='Valmis'; }
  ctx.clearRect(0,0,cvs.width,cvs.height);
  drawMachine();  // <-- suu ja paneeli joka framella
  hud();
  requestAnimationFrame(loop);
}
})();
</script>
